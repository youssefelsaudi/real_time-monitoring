<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weekly Report</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <style>
        body {
            background-color: #f8f9fa; /* Light background color for the page */
            font-family: 'Arial', sans-serif; /* Set a custom font */
        }

        .container {
            max-width: 1000px; /* Set a maximum width for the content */
            margin-top: 50px; /* Add some space on top */
        }

        table {
            margin-top: 20px; /* Add space between the heading and table */
        }

        th, td {
            text-align: center; /* Center align the text in table cells */
        }

        td {
            font-weight: bold; /* Make the cell text bold */
        }

        /* Styling for the totals row */
        tr:last-child {
            background-color: #d1e7dd; /* Light green background for totals row */
        }

        tr:last-child td {
            font-size: 1.1em; /* Increase font size for the totals row */
        }

        .btn {
            border-radius: 10px; /* Rounded corners for the button */
        }

        .btn-primary {
            background-color: #007bff; /* Custom button color */
            border-color: #007bff;
        }

        .btn-primary:hover {
            background-color: #0056b3; /* Darker color on hover */
            border-color: #0056b3;
        }

        .working-hours-summary {
            margin-top: 30px;
            background-color: #e9ecef;
            padding: 20px;
            border-radius: 8px;
        }

        .working-hours-summary h4 {
            font-size: 1.25em;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h2>Weekly Report</h2>
        
        <!-- Table to display weekly report -->
        <table id="weeklyReportTable" class="table table-striped">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Total Working Time (hours)</th>
                    <th>Load Exceedances</th>
                    <th>Frequency Exceedances</th>
                    <th>Length Exceedances</th>
                </tr>
            </thead>
            <tbody>
                <!-- Data rows will be populated here via JavaScript -->
            </tbody>
        </table>

        <!-- Optional: Add a button to refresh data -->
        <button class="btn btn-primary mt-3" onclick="fetchWeeklyReportData()">Refresh Data</button>

        <!-- Working hours summary region -->
        <div class="working-hours-summary">
            <h4>Total Working Hours per Day</h4>
            <div id="workingHoursPerDay"></div>
        </div>
    </div>

    <!-- Script to fetch and populate data -->
    <script>
        function fetchWeeklyReportData() {
            fetch('https://api.thingspeak.com/channels/2741407/feeds.json?api_key=HNSZO7OR50SIIPF4')
                .then(response => response.json())
                .then(data => {
                    const weeklyData = data.feeds.filter(entry => {
                        const entryDate = new Date(entry.created_at);
                        const sevenDaysAgo = new Date();
                        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                        return entryDate >= sevenDaysAgo;
                    });

                    let totalWorkingTime = 0;
                    let loadExceedances = 0;
                    let frequencyExceedances = 0;
                    let lengthExceedances = 0;

                    const tableBody = document.querySelector('#weeklyReportTable tbody');
                    tableBody.innerHTML = '';

                    // Object to store total working hours per day
                    const workingHoursPerDay = {};

                    weeklyData.forEach(entry => {
                        const date = new Date(entry.created_at).toLocaleDateString();
                        const workingTime = parseFloat(entry.field6);
                        const loadExceed = parseInt(entry.field7);
                        const frequencyExceed = parseInt(entry.field8);
                        const lengthExceed = parseInt(entry.field9);

                        // Update total working hours per day
                        if (!workingHoursPerDay[date]) {
                            workingHoursPerDay[date] = 0;
                        }
                        workingHoursPerDay[date] += workingTime;

                        totalWorkingTime += workingTime;
                        loadExceedances += loadExceed;
                        frequencyExceedances += frequencyExceed;
                        lengthExceedances += lengthExceed;

                        // Add row to the table
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${date}</td>
                            <td>${workingTime.toFixed(2)}</td>
                            <td>${loadExceed > 0 ? loadExceed : ''}</td>
                            <td>${frequencyExceed > 0 ? frequencyExceed : ''}</td>
                            <td>${lengthExceed > 0 ? lengthExceed : ''}</td>
                        `;
                        tableBody.appendChild(row);
                    });

                    // Create totals row
                    const totalsRow = document.createElement('tr');
                    totalsRow.innerHTML = `
                        <td><strong>Total</strong></td>
                        <td><strong>${totalWorkingTime.toFixed(2)}</strong></td>
                        <td><strong>${loadExceedances}</strong></td>
                        <td><strong>${frequencyExceedances}</strong></td>
                        <td><strong>${lengthExceedances}</strong></td>
                    `;
                    tableBody.appendChild(totalsRow);

                    // Display total working hours per day in the summary region
                    const workingHoursDiv = document.querySelector('#workingHoursPerDay');
                    workingHoursDiv.innerHTML = '';
                    Object.keys(workingHoursPerDay).forEach(date => {
                        const workingHours = workingHoursPerDay[date].toFixed(2);
                        workingHoursDiv.innerHTML += `<p><strong>${date}:</strong> ${workingHours} hours</p>`;
                    });
                })
                .catch(error => {
                    console.error('Error fetching the data:', error);
                });
        }

        window.onload = fetchWeeklyReportData;
    </script>
</body>
</html>
