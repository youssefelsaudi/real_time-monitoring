<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weekly Report</title>
    <!-- You can include a CSS framework like Bootstrap for styling -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h2>Weekly Report</h2>
        
        <!-- Table to display weekly report -->
        <table id="weeklyReportTable" class="table table-striped">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Total Working Time (hours)</th>
                    <th>Load Exceedances</th>
                    <th>Frequency Exceedances</th>
                    <th>Length Exceedances</th>
                </tr>
            </thead>
            <tbody>
                <!-- Data rows will be populated here via JavaScript -->
            </tbody>
        </table>

        <!-- Optional: Add a button to refresh data -->
        <button class="btn btn-primary mt-3" onclick="fetchWeeklyReportData()">Refresh Data</button>
    </div>

    <!-- Script to fetch and populate data -->
    <script>
        function fetchWeeklyReportData() {
            fetch('https://api.thingspeak.com/channels/2741407/feeds.json?api_key=HNSZO7OR50SIIPF4')
                .then(response => response.json())
                .then(data => {
                    // Filter the data for the last 7 days
                    const weeklyData = data.feeds.filter(entry => {
                        const entryDate = new Date(entry.created_at);
                        const sevenDaysAgo = new Date();
                        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                        return entryDate >= sevenDaysAgo;
                    });

                    let totalWorkingTime = 0;
                    let loadExceedances = 0;
                    let frequencyExceedances = 0;
                    let lengthExceedances = 0;

                    // Empty the table body before adding new data
                    const tableBody = document.querySelector('#weeklyReportTable tbody');
                    tableBody.innerHTML = '';

                    // Populate table rows with data
                    weeklyData.forEach(entry => {
                        totalWorkingTime += parseFloat(entry.field6);
                        loadExceedances += parseInt(entry.field7);
                        frequencyExceedances += parseInt(entry.field8);
                        lengthExceedances += parseInt(entry.field9);

                        // Create a new table row for each entry
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${new Date(entry.created_at).toLocaleDateString()}</td>
                            <td>${parseFloat(entry.field6).toFixed(2)}</td>
                            <td>${parseInt(entry.field7)}</td>
                            <td>${parseInt(entry.field8)}</td>
                            <td>${parseInt(entry.field9)}</td>
                        `;
                        tableBody.appendChild(row);
                    });

                    // Update the totals row at the bottom
                    const totalsRow = document.createElement('tr');
                    totalsRow.innerHTML = `
                        <td><strong>Total</strong></td>
                        <td><strong>${totalWorkingTime.toFixed(2)}</strong></td>
                        <td><strong>${loadExceedances}</strong></td>
                        <td><strong>${frequencyExceedances}</strong></td>
                        <td><strong>${lengthExceedances}</strong></td>
                    `;
                    tableBody.appendChild(totalsRow);
                })
                .catch(error => {
                    console.error('Error fetching the data:', error);
                });
        }

        // Automatically fetch and populate data when the page loads
        window.onload = fetchWeeklyReportData;
    </script>
</body>
</html>
