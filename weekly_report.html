<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Weekly Report</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
    }
    button {
      padding: 10px 20px;
      margin: 20px 0;
      font-size: 16px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>Weekly Report</h1>

  <div>
    <h2>Exceedances Overview</h2>
    <canvas id="weeklyReportChart" width="400" height="200"></canvas>
  </div>

  <button onclick="window.location.href = 'index.html'">Back to Dashboard</button>

  <script>
    // Function to aggregate data by week and render the weekly report chart
    function renderWeeklyReportChart() {
      fetch('https://api.thingspeak.com/channels/2741407/feeds.json?api_key=HNSZO7OR50SIIPF4&results=168')  // Get the last 168 entries (7 days * 24 hours)
        .then(response => response.json())
        .then(data => {
          // Prepare arrays for the aggregated data
          let weeklyData = {
            labels: [],  // Store labels (week number or date range)
            loadExceedancesData: [],
            frequencyExceedancesData: [],
            lengthExceedancesData: [],
            totalWorkingTimeData: []
          };

          let currentWeek = null;
          let weekLoadExceedances = 0;
          let weekFrequencyExceedances = 0;
          let weekLengthExceedances = 0;
          let weekWorkingTime = 0;
          let weekStartDate = null;

          // Helper function to format the date to a 'Week Number' format
          function getWeekOfYear(date) {
            const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
            const daysOfYear = (date - firstDayOfYear) / (24 * 60 * 60 * 1000);
            return Math.floor(daysOfYear / 7) + 1;  // Return the week number
          }

          // Process each feed to aggregate data by week
          data.feeds.forEach(feed => {
            const date = new Date(feed.created_at);
            const weekOfYear = getWeekOfYear(date);
            const loadExceedances = feed.field7 ? parseInt(feed.field7.split(',')[0]) : 0;
            const frequencyExceedances = feed.field7 ? parseInt(feed.field7.split(',')[1]) : 0;
            const lengthExceedances = feed.field7 ? parseInt(feed.field7.split(',')[2]) : 0;
            const totalWorkingTime = feed.field6 ? parseFloat(feed.field6) : 0;

            // Start a new week group if the week has changed
            if (currentWeek === null || weekOfYear !== currentWeek) {
              // If it's not the first week, push the previous week's data
              if (currentWeek !== null) {
                weeklyData.labels.push(`Week ${currentWeek}`);
                weeklyData.loadExceedancesData.push(weekLoadExceedances);
                weeklyData.frequencyExceedancesData.push(weekFrequencyExceedances);
                weeklyData.lengthExceedancesData.push(weekLengthExceedances);
                weeklyData.totalWorkingTimeData.push(weekWorkingTime);
              }
              // Reset values for the new week
              currentWeek = weekOfYear;
              weekLoadExceedances = 0;
              weekFrequencyExceedances = 0;
              weekLengthExceedances = 0;
              weekWorkingTime = 0;
              weekStartDate = date;
            }

            // Aggregate data for the current week
            weekLoadExceedances += loadExceedances;
            weekFrequencyExceedances += frequencyExceedances;
            weekLengthExceedances += lengthExceedances;
            weekWorkingTime += totalWorkingTime;
          });

          // Add the last week data after the loop
          if (currentWeek !== null) {
            weeklyData.labels.push(`Week ${currentWeek}`);
            weeklyData.loadExceedancesData.push(weekLoadExceedances);
            weeklyData.frequencyExceedancesData.push(weekFrequencyExceedances);
            weeklyData.lengthExceedancesData.push(weekLengthExceedances);
            weeklyData.totalWorkingTimeData.push(weekWorkingTime);
          }

          // Render the chart with aggregated weekly data
          new Chart(document.getElementById('weeklyReportChart'), {
            type: 'line',
            data: {
              labels: weeklyData.labels,
              datasets: [
                {
                  label: 'Load Exceedances',
                  data: weeklyData.loadExceedancesData,
                  borderColor: 'red',
                  fill: false
                },
                {
                  label: 'Frequency Exceedances',
                  data: weeklyData.frequencyExceedancesData,
                  borderColor: 'blue',
                  fill: false
                },
                {
                  label: 'Length Exceedances',
                  data: weeklyData.lengthExceedancesData,
                  borderColor: 'green',
                  fill: false
                },
                {
                  label: 'Working Time (Hours)',
                  data: weeklyData.totalWorkingTimeData,
                  borderColor: 'purple',
                  fill: false,
                  yAxisID: 'y-axis-2'
                }
              ]
            },
            options: {
              responsive: true,
              scales: {
                x: {
                  title: {
                    display: true,
                    text: 'Week'
                  }
                },
                y: {
                  title: {
                    display: true,
                    text: 'Exceedances'
                  }
                },
                'y-axis-2': {
                  type: 'linear',
                  position: 'right',
                  title: {
                    display: true,
                    text: 'Working Time (hrs)'
                  },
                  grid: {
                    drawOnChartArea: false
                  }
                }
              }
            }
          });
        })
        .catch(error => {
          console.error('Error fetching data for weekly report:', error);
        });
    }

    // Call the function to render the weekly report chart
    renderWeeklyReportChart();
  </script>
</body>
</html>
